# 智能网关方案

## 网关概述

智能网关采集控制现场过程数据，再将采集数据通过MQTT等协议上传到云端。

### 硬件采集接口
* Eth
  接入设备主要包括：cnc、plc、modbus tcp
* RS485
  接入设备主要包括：plc、modbus rtu
* DI
  接入为数字量信号输入，主要功能为：表示状态或告警和计件
  
### 上行协议
网关对接云平台或服务器的上行协议主要包括：
* MQTT(云端接口)：以此为主
* http(cliet)：主要用做文件传输接口，也可以用作数据上报接口
* websocket(cliet)
* mtconnect
* opc ua
### 本地管理
* 内嵌web server
* websocket(server)
  局端管理软件可通过此接口进行管理
## 采集设备接入方案一
接入设备根据介入协议不同，拟采用以下接入方式：
###  modbus协议接入
modbus协议设备的接入以自定义的方式进行接入，格式如下：
#### 基本信息：

|设备编号|设备型号|采集周期|接口信息|内存信息|
| ---- | ---- |---- |

设备型号分为modbus tcp 和modbus rtu两类，对应的接口信息对应如下：
* modbus tcp:

|ip地址|端口号|
| ---- | ---- |
* modbus rtu:

|串口设备|从机地址|波特率|数据位|校验位|停止位|
| ---- | ---- |---- |

#### 自定义信息：
|数据类型|变量名|变量地址|位地址|功能码|
| ---- | ---- |---- |
###  PLC设备接入
PLC协议设备的接入以自定义的方式进行接入，格式如下：
#### 基本信息：

|设备编号|设备型号|采集周期|接口信息|内存信息|
| ---- | ---- |---- |

设备型号分为tcp 和rs485两类，对应的接口信息对应如下：
* tcp:

|ip地址|端口号|
| ---- | ---- |
* rs485:

|串口设备|从机地址|波特率|数据位|校验位|停止位|
| ---- | ---- |---- |

#### 自定义信息：
|数据类型|变量名|变量地址|
| ---- | ---- |---- |

### cnc机床设备接入
此类主要是针对eth连接的cnc机床，厂家提供机床库文件。
此类机床的接入思想是，根据库提供的函数接口，生成设备调用的方法和属性，用c++实现方法就是封装成类。
用c的方法实现就是根据库接口注册相应的回调函数，定义一个协议簇，根据协议进行相关调用。
模块对内部接入方法生成简介，可供外部获取，查询模块熟悉。

二次开发或应用开发的时候可以将这些方法进行组合，以获取想要的数据或操作。

## 采集设备接入方案二
采集设备方案二的设计思想，主要是参照目前主流iot平台的物模型的方式，以网关和子设备的方式运行。
网关只负责子设备的管理，以及子设备和云平台数据的中转。机床（末端设备）的接入在子设备里进行,网关不关心其具体实现。

* 子设备可以是：独立的硬件设备、独立的应用和网关上运行的子程序 
网关上运行的子程序，第一次使用时可以通过云端加载到本地，但是须保证程序是在盒子上可以正常运行。

* 子设备上运行一个tcp server作为对外接口 

* 子程序的接口满足公司定义的规范即可，对开发语言没有限定，只要是在盒子上验证过能稳定运行的程序即可。
但是考虑到程序的保密问题，推荐使用C和C++开发的程序和少量脚本

* 子程序成功下载后生成本地路径，下次从本地自动运行。子程序从网络下载后的首次运行，正常是不需要重启网关的。

* 子程序升级只需要从服务器下载下载指定版本，替换本地版本即可，需要子程序结束重新启动

边缘计算：可以对上报的数据，通过设定的规则，进行简单的脚本解析；

##### 此种方案的主要优点就是灵活，结构清晰；

##### 主要缺点是：
* rs485这种一对多的应用，需要加一些限定和处理；
* 对于分布式应用的时候，子设备ip是动态获取这种清楚，需要有一套机制才能保证网关和子设备的链接稳定。


### 子设备创建流程


``` mermaid
graph LR
    A[云平台] --下发子设备相关信息--> B[网关] 
    B[网关] -- 建立子设备信息索引 -->C{子设备类型}
    C -->|子程序| D[下载/启动子程序]
    C -->|子设备| E[连接子设备]
```	
### 云平台与子设备交互流程


``` mermaid
graph LR
   
     A1[云平台] --下发子设备控制/查询信息--> B1[网关] 
    B1[网关] -- 根据索引查找子设备/信息下发给子设备 -->C2[子设备]
    
  C2[子设备] -- 返回信息 -->  B1[网关]  
  B1[网关]  --格式化信息/预处理-->  A1[云平台] 